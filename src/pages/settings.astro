---
import Layout from '@layouts/Layout.astro';
import SettingsComponent from '../components/Settings.jsx';
import { SettingsProvider } from '../contexts/SettingsContext.jsx';
import { siteConfig } from '@config/site';
import PWAInstallPrompt from '../components/PWAInstallPrompt.jsx';
import OfflineIndicator from '../components/OfflineIndicator.jsx';
---

<Layout
  title="Settings - " + siteConfig.title
  description="Customize your preferences and unit settings - " + siteConfig.title
  wideContent={true}
  showHeader={false}
  showBottomNav={true}
  showTopNav={false}
  showFooter={false}
>
  <main class="w-full bg-gray-50 flex flex-col min-h-screen overflow-y-auto" style="touch-action: pan-y; -webkit-overflow-scrolling: touch;">
    <!-- Top Navigation Header -->
    <div class="bg-white border-b border-gray-200 shadow-sm sticky top-0 z-10">
      <div class="max-w-6xl mx-auto px-4 py-3">
        <div class="flex items-center justify-between gap-3">
          <div class="flex items-center gap-3">
            <a
              href="/"
              class="flex items-center justify-center p-2 text-gray-600 hover:text-gray-900 hover:bg-gray-100 rounded-lg transition-colors"
              title="Back to Calendar"
            >
              <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18" />
              </svg>
            </a>
            <div class="text-lg font-bold text-gray-900 truncate pr-2">
              My Settings
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Content -->
    <div class="flex-1 py-6 sm:py-12 bg-gradient-to-br from-blue-50 via-white to-indigo-50">
      <div class="max-w-6xl mx-auto px-4 sm:px-6 lg:px-8">
        <!-- Calorie Calculator Goals -->
        <div id="calorieGoalsSection" class="bg-white rounded-lg shadow-lg p-4 sm:p-6 mb-6 max-w-4xl mx-auto hidden">
          <h4 class="text-lg font-medium text-gray-900 mb-4">My Calorie Goals</h4>
          <div class="grid grid-cols-1 sm:grid-cols-3 gap-4 mb-4">
            <div class="bg-blue-50 rounded-lg p-4 border border-blue-200">
              <h3 class="text-sm font-medium text-blue-800 mb-2">Weight Loss</h3>
              <p class="text-2xl font-bold text-blue-600 mb-1" id="goal-weight-loss">-</p>
              <p class="text-sm text-gray-500">calories/day</p>
            </div>
            <div class="bg-green-50 rounded-lg p-4 border border-green-200">
              <h3 class="text-sm font-medium text-green-800 mb-2">Maintenance</h3>
              <p class="text-2xl font-bold text-green-600 mb-1" id="goal-maintenance">-</p>
              <p class="text-sm text-gray-500">calories/day</p>
            </div>
            <div class="bg-orange-50 rounded-lg p-4 border border-orange-200">
              <h3 class="text-sm font-medium text-orange-800 mb-2">Weight Gain</h3>
              <p class="text-2xl font-bold text-orange-600 mb-1" id="goal-weight-gain">-</p>
              <p class="text-sm text-gray-500">calories/day</p>
            </div>
          </div>
          <div class="pt-4 border-t border-gray-200">
            <a href="/calorie-calculator" class="text-sm text-blue-600 hover:text-blue-700 hover:underline">
              Calculate Your Calories here
            </a>
          </div>
        </div>

        <!-- Statistics Card -->
        <div class="bg-white rounded-lg shadow-lg p-4 sm:p-6 mb-6 max-w-4xl mx-auto">
          <a href="/statistics/" class="block hover:shadow-xl transition-shadow duration-200">
            <div class="flex items-center justify-between">
              <div class="flex-1">
                <h4 class="text-lg font-medium text-gray-900 mb-2">Health Statistics</h4>
                <p class="text-sm text-gray-500">View your health statistics, graphs, and analytics</p>
              </div>
              <div class="ml-4 flex-shrink-0">
                <svg class="w-5 h-5 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" />
                </svg>
              </div>
            </div>
          </a>
        </div>

        <SettingsProvider>
          <SettingsComponent client:load />
        </SettingsProvider>

        <!-- Frequent Questions -->
        <section class="max-w-4xl mx-auto mt-12 mb-8">
          <h2 class="text-2xl md:text-3xl font-bold text-gray-900 dark:text-white mb-6">Frequent Questions</h2>
          <div class="divide-y divide-gray-200 dark:divide-gray-700 rounded-xl border border-gray-200 dark:border-gray-700 bg-white dark:bg-gray-800 shadow-sm">
            <details class="group p-4" open>
              <summary class="flex cursor-pointer list-none items-center justify-between gap-4">
                <span class="text-lg font-semibold text-gray-900 dark:text-white">What kind of information can I log with this app?</span>
                <svg class="h-5 w-5 text-gray-500 dark:text-gray-400 transition-transform group-open:rotate-180 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/>
                </svg>
              </summary>
              <div class="mt-3 text-base text-gray-600 dark:text-gray-300 leading-relaxed">
                You are in control and can log whatever information your want. This app is completely flexible ‚Äì you're in total control of what you track and how much detail you add. You can log anything you find useful and are not required to fill in every field.
              </div>
            </details>
            <details class="group p-4">
              <summary class="flex cursor-pointer list-none items-center justify-between gap-4">
                <span class="text-lg font-semibold text-gray-900 dark:text-white">How do I use the camera to add photos?</span>
                <svg class="h-5 w-5 text-gray-500 dark:text-gray-400 transition-transform group-open:rotate-180 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/>
                </svg>
              </summary>
              <div class="mt-3 text-base text-gray-600 dark:text-gray-300 leading-relaxed">
                You can attach photos to any entry using the camera feature. Your photos are saved with the entry and appear in your personal gallery whenever you view it. Perfect for food pics, progress shots, or anything you want to remember visually!
              </div>
            </details>
            <details class="group p-4">
              <summary class="flex cursor-pointer list-none items-center justify-between gap-4">
                <span class="text-lg font-semibold text-gray-900 dark:text-white">How do I log a meal with nutrition info?</span>
                <svg class="h-5 w-5 text-gray-500 dark:text-gray-400 transition-transform group-open:rotate-180 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/>
                </svg>
              </summary>
              <div class="mt-3 text-base text-gray-600 dark:text-gray-300 leading-relaxed">
                How do I log a meal?
                Click a date on the calendar, select "Add Meal", then fill in the meal name and amount (e.g., "1 cup"). You can optionally add nutrition details like calories, protein, carbs, and fats, but these aren't required. Use the autocomplete to quickly select from your food library.
              </div>
            </details>
            <details class="group p-4">
              <summary class="flex cursor-pointer list-none items-center justify-between gap-4">
                <span class="text-lg font-semibold text-gray-900 dark:text-white">How do I log sleep?</span>
                <svg class="h-5 w-5 text-gray-500 dark:text-gray-400 transition-transform group-open:rotate-180 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/>
                </svg>
              </summary>
              <div class="mt-3 text-base text-gray-600 dark:text-gray-300 leading-relaxed">
                Click a date on the calendar, select "Add Sleep", then set your bedtime and wake time. The app will automatically calculate your sleep duration. You can add notes about sleep quality if desired.
              </div>
            </details>
            <details class="group p-4">
              <summary class="flex cursor-pointer list-none items-center justify-between gap-4">
                <span class="text-lg font-semibold text-gray-900 dark:text-white">What is the food library?</span>
                <svg class="h-5 w-5 text-gray-500 dark:text-gray-400 transition-transform group-open:rotate-180 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/>
                </svg>
              </summary>
              <div class="mt-3 text-base text-gray-600 dark:text-gray-300 leading-relaxed">
                Your personal database of frequently used foods and meals. Click "Manage Library" to add, edit, or delete items. The autocomplete will suggest items from your library as you type, making data entry much faster.
              </div>
            </details>
            <details class="group p-4">
              <summary class="flex cursor-pointer list-none items-center justify-between gap-4">
                <span class="text-lg font-semibold text-gray-900 dark:text-white">How do I reorder my entries?</span>
                <svg class="h-5 w-5 text-gray-500 dark:text-gray-400 transition-transform group-open:rotate-180 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/>
                </svg>
              </summary>
              <div class="mt-3 text-base text-gray-600 dark:text-gray-300 leading-relaxed">
                Simply drag and drop any entry to reorder them. Entries with the same time are grouped together and can be collapsed/expanded by clicking the time header.
              </div>
            </details>
            <details class="group p-4">
              <summary class="flex cursor-pointer list-none items-center justify-between gap-4">
                <span class="text-lg font-semibold text-gray-900 dark:text-white">How are entries grouped by time?</span>
                <svg class="h-5 w-5 text-gray-500 dark:text-gray-400 transition-transform group-open:rotate-180 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/>
                </svg>
              </summary>
              <div class="mt-3 text-base text-gray-600 dark:text-gray-300 leading-relaxed">
                All entries for the same time (e.g., 8:00 AM) are automatically grouped together under a single time header. This keeps your log organized and makes it easy to see what you did at specific times. Click the time header to collapse or expand each group. You can have multiple meals or sleep entries at the same time.
              </div>
            </details>
            <details class="group p-4">
              <summary class="flex cursor-pointer list-none items-center justify-between gap-4">
                <span class="text-lg font-semibold text-gray-900 dark:text-white">How do I manage my data?</span>
                <svg class="h-5 w-5 text-gray-500 dark:text-gray-400 transition-transform group-open:rotate-180 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/>
                </svg>
              </summary>
              <div class="mt-3 text-base text-gray-600 dark:text-gray-300 leading-relaxed">
                Use the Library to manage your food items, Settings to customize units and preferences, and Export to backup your data. All your entries are automatically saved and can be edited or deleted as needed.
              </div>
            </details>
            <details class="group p-4">
              <summary class="flex cursor-pointer list-none items-center justify-between gap-4">
                <span class="text-lg font-semibold text-gray-900 dark:text-white">How do I add notes to entries?</span>
                <svg class="h-5 w-5 text-gray-500 dark:text-gray-400 transition-transform group-open:rotate-180 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/>
                </svg>
              </summary>
              <div class="mt-3 text-base text-gray-600 dark:text-gray-300 leading-relaxed">
                Click the information (i) button next to any entry to add notes or additional details. This is useful for tracking how you felt, intensity levels, or any other observations.
              </div>
            </details>
            <details class="group p-4">
              <summary class="flex cursor-pointer list-none items-center justify-between gap-4">
                <span class="text-lg font-semibold text-gray-900 dark:text-white">Where is my data stored?</span>
                <svg class="h-5 w-5 text-gray-500 dark:text-gray-400 transition-transform group-open:rotate-180 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/>
                </svg>
              </summary>
              <div class="mt-3 text-base text-gray-600 dark:text-gray-300 leading-relaxed">
                All data is stored locally in your browser using IndexedDB, which is more reliable than regular storage. Your data stays private and is not sent to any servers. Use the Export feature to backup your data.
              </div>
            </details>
            <details class="group p-4">
              <summary class="flex cursor-pointer list-none items-center justify-between gap-4">
                <span class="text-lg font-semibold text-gray-900 dark:text-white">How do I export my data?</span>
                <svg class="h-5 w-5 text-gray-500 dark:text-gray-400 transition-transform group-open:rotate-180 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/>
                </svg>
              </summary>
              <div class="mt-3 text-base text-gray-600 dark:text-gray-300 leading-relaxed">
                Use the export functionality to backup your data in JSON, CSV, or PDF formats. This includes all your entries with nutrition and sleep details.
              </div>
            </details>
            <details class="group p-4">
              <summary class="flex cursor-pointer list-none items-center justify-between gap-4">
                <span class="text-lg font-semibold text-gray-900 dark:text-white">How do I add this app to my home screen?</span>
                <svg class="h-5 w-5 text-gray-500 dark:text-gray-400 transition-transform group-open:rotate-180 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/>
                </svg>
              </summary>
              <div class="mt-3 text-base text-gray-600 dark:text-gray-300 leading-relaxed">
                <div class="space-y-3">
                  <div>
                    <strong>üì± For Android devices:</strong>
                    <ol class="list-decimal list-inside mt-1 space-y-1 ml-2">
                      <li>Open this website in Chrome browser</li>
                      <li>Tap the menu button (three dots) in the top right</li>
                      <li>Select "Add to Home screen" or "Install app"</li>
                      <li>Tap "Add" to confirm</li>
                    </ol>
                  </div>
                  <div>
                    <strong>üçé For iOS devices (iPhone/iPad):</strong>
                    <ol class="list-decimal list-inside mt-1 space-y-1 ml-2">
                      <li>Open this website in Safari browser</li>
                      <li>Tap the Share button (square with arrow up)</li>
                      <li>Scroll down and tap "Add to Home Screen"</li>
                      <li>Tap "Add" to confirm</li>
                    </ol>
                  </div>
                  <div class="text-xs text-gray-500 dark:text-gray-400 mt-2">
                    üí° Once installed, the app will work like a native app with its own icon on your home screen!
                  </div>
                </div>
              </div>
            </details>
          </div>
        </section>
      </div>
    </div>
  </main>
  
  <!-- PWA Components -->
  <PWAInstallPrompt client:load />
  <OfflineIndicator client:load />

  <script>
    // Function to load calculator data from localStorage
    function loadCalculatorData() {
      try {
        const savedData = localStorage.getItem('calorieCalculatorData');
        if (savedData) {
          return JSON.parse(savedData);
        }
      } catch (e) {
        console.error('Error loading calculator data:', e);
      }
      return null;
    }

    // Function to display calorie goals
    function displayCalorieGoals() {
      const calculatorData = loadCalculatorData();
      if (!calculatorData) {
        return;
      }

      const goalsSection = document.getElementById('calorieGoalsSection');
      if (!goalsSection) {
        return;
      }

      // Show the goals section
      goalsSection.classList.remove('hidden');

      const weightLoss = calculatorData.weightLoss || 0;
      const maintenance = calculatorData.maintenance || 0;
      const weightGain = calculatorData.weightGain || 0;

      // Update weight loss goal
      const weightLossEl = document.getElementById('goal-weight-loss');
      if (weightLossEl) {
        weightLossEl.textContent = weightLoss.toString();
      }

      // Update maintenance goal
      const maintenanceEl = document.getElementById('goal-maintenance');
      if (maintenanceEl) {
        maintenanceEl.textContent = maintenance.toString();
      }

      // Update weight gain goal
      const weightGainEl = document.getElementById('goal-weight-gain');
      if (weightGainEl) {
        weightGainEl.textContent = weightGain.toString();
      }
    }

    // Load and display goals when page loads
    window.addEventListener('DOMContentLoaded', function() {
      displayCalorieGoals();
    });

    // Reload goals when window gains focus (in case calculator was updated in another tab)
    window.addEventListener('focus', function() {
      displayCalorieGoals();
    });
  </script>
</Layout>
